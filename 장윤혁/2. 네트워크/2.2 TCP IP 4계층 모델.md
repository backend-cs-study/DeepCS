# 2.2 TCP/IP 4계층 모델

## 인터넷 프로토콜 스위트(internet protocol suite)
인터넷에서 컴퓨터들이 서로 정보를 주고받는 데 쓰이는 프로토콜`(통신규약)`의 집합  
프로토콜의 네트워킹 범위에 따라 추상화 계층으로 구성  
**특정 계층이 변경되었을 때 다른 계층이 영향을 받지 않도록 설계됨**
## 2.2.1 계층 구조
- ### TCP/IP(Transmission Control Protocol / Internet Protocol) 4계층
    패킷 통신 방식의 인터넷 프로토콜인 `IP`와 전송 프로토콜인 `TCP`로 이루어져 있음  
    IP 주소 체계를 따르고 IP Routing을 이용해 목적지에 도달하며 TCP의 특성을 활용해 송신자와 수신자의 논리적 연결을 생성하고 신뢰성을 유지할 수 있도록 함

    <br>
  
  - 애플리케이션 계층
  - 전송 계층
  - 인터넷 계층
  - 링크 계층
- ### OSI 7계층
  - 애플리케이션 계층
  - 프레젠테이션 계층
  - 세션 계층
  - 전송 계층
  - 네트워크 계층
  - 데이터 링크 계층
  - 물리 계층

## 애플리케이션 계층
FTP, HTTP, SSH, SMTP, DNS 등 `응용 프로그램이 사용되는 프로토콜 계층`  
웹 서비스, 이메일 등 `서비스를 실질적으로 사람들에게 제공하는 층`
- ### FTP
    장치와 장치 간의 파일을 전송하는 데 사용되는 표준 통신 프로토콜
- ### SSH
    보안되지 않은 네트워크에서 네트워크 서비스를 안전하게 운영하기 위한 암호화 네트워크 프로토콜
- ### HTTP
    World Wide Web 을 위한 데이터 통신의 기초이자 웹 사이트를 이용하는 데 쓰는 프로토콜
- ### SMTP
    전자 메일 전송을 위한 인터넷 표준 통신 프로토콜
- ### DNS
    도메인 이름과 IP 주소를 매핑해주는 서버

## 전송 계층
`송신자와 수신자를 연결하는 통신 서비스를 제공`  
연결 지향 데이터 스트림 지원, 신뢰성, 흐름 제어를 제공  
애플리케이션과 인터넷 계층 사이의 데이터가 전달될 때 중계 역할을 함
- ### TCP
    `패킷 사이의 순서를 보장`  
    연결지향 프로토콜을 사용해서 연결을 하여 신뢰성을 구축해서 수신 여부를 확인하며 `가상회선 패킷 교환 방식`을 사용
  - 가상회선 패킷 교환 방식 : 각 패킷에는 가상회선 식별자가 포함되며 모든 패킷을 전송하면 가상회선이 해제되고 패킷들은 전송된 순서대로 도착하는 방식
  ![Image](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FohZuj%2FbtrWQehRqKD%2FHabgOmSmUuK6yjqYi1m1mK%2Fimg.jpg)
  
  <br>
  
  - TCP 연결 성립 과정 : 신뢰성을 확보하기 위해 `3-way-handshake`작업을 진행
  ![Image](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Ft1.daumcdn.net%2Fcfile%2Ftistory%2F225A964D52F1BB6917)
    - SYN(연결 요청 플래그) 단계 : 클라이언트는 서버에 클라이언트의 ISN(새로운 TCP 연결의 첫 번째 패킷에 할당된 임의의 시퀀스 번호)을 담아 SYN 을 보냄
    - SYN + ACK(응답 플래그) 단계 : 서버는 클라이언트의 SYN 을 수신하고 서버의 ISN 을 보내며 승인번호로 클라이언트의 ISN + 1 을 보냄
    - ACK 단계 : 클라이언트는 서버의 ISN + 1 한 값인 승인번호를 담아 ACK 를 서버에 보냄
  
    <br>
    
  - TCP 연결 해제 과정 : `4-way-handshake` 진행
  ![Image](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Ft1.daumcdn.net%2Fcfile%2Ftistory%2F2152353F52F1C02835)
    - #1 : 클라이언트가 연결을 닫으려고 할 때 FIN 으로 설정된 세그먼트를 보냄. 이후 클라이언트는 FIN_WAIT_1 상태로 들어가고 서버의 응답을 기다림
    - #2 : 서버는 클라이언트로 ACK 라는 승인 세그먼트를 보냄. 이후 CLOSE_WAIT 상태에 들어가며 클라이언트는 승인 세그먼트를 받고난 뒤 FIN_WAIT_2 상태에 들어감
    - #1 : 서버는 ACK 세그먼트를 보내고 일정 시간 이후에 클라이언트에 FIN 이라는 세그먼트를 보냄
    - #2 : 클라이언트는 TIME_WAIT 상태가 되고 다시 서버로 ACK 를 보내서 서버는 CLOSED 상태가 됨. 이후 클라이언트는 어느 정도의 시간을 대기한 후 연결이 닫히고 클라이언트와 서버의 모든 자원의 연결이 해제됨
    - ### TIME_WAIT : 소켓이 바로 소멸되지 않고 일정 시간 유지되는 상태
      1. 지연 패킷 발생의 경우를 대비 (패킷이 뒤늦게 도달하고 이를 처리하지 못한다면 데이터 무결성 문제가 발생)
      2. 두 장치가 연결이 닫혔는지 확인하기 위함 (만약 LAST_ACK 상태에서 닫히게 되면 다시 새로운 연결을 하려고 할 때 장치는 줄곧 LAST_ACK 로 되어 있기 때문에 접속 오류가 발생)
- ### UDP
    `순서를 보장하지 않고 수신 여부를 확인하지 않음`  
    단순히 데이터만 주는 `데이터그램 패킷 교환 방식`을 사용
  - 데이터그램 패킷 교환 방식 : 패킷이 독립적으로 이동하며 최적의 경로를 선택하여 가는데, 하나의 메시지에서 분할된 여러 패킷은 서로 다른 경로로 전송될 수 있으며 도착한 순서가 다를 수 있는 방식
  ![Image](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2Fd2pbwq%2FbtrWRPVgHnt%2FUnyedIcMRjWGbZDrqdD9J1%2Fimg.jpg)

## 인터넷 계층
장치로부터 받은 네트워크 패킷을 IP 주소로 지정된 목적지로 전송하기 위해 사용되는 계층  
IP, ARP, ICMP 등이 있으며 패킷을 수신해야 할 상대의 주소를 지정하여 데이터를 전달  
상대방이 제대로 받았는지에 대해 보장하지 않는 비연결형적인 특징을 갖고 있음  

## 링크 계층(= 네트워크 접근 계층)
전선, 광섬유, 무선 등으로 실질적으로 데이터를 전달하며 장치 간에 시놀르 주고받는 규칙을 정하는 계층  
`물리 계층`과 `데이터 링크 계층`으로 나누기도 함
- ### 물리 계층
    무선 LAN 과 유선 LAN 을 통해 0과 1로 이루어진 데이터를 보내는 계층
  - #### 전이중화 통신(full duplex) : 양쪽 장치가 동시에 송수신할 수 있는 방식, 유선 LAN 에서 사용됨
    송신로와 수신로로 나눠서 데이터를 주고받으며 현대의 고속 이더넷은 이 방식을 기반으로 통신하고 있음
  - #### 반이중화 통신(half duplex) : 양쪽 장치는 서로 통신할 수 있지만, 동시에는 통신할 수 없으며 한 번에 한 방향만 통신할 수 있는 방식, 무선 LAN 에서 사용됨
    둘 이상의 장치가 동시에 전송하면 충돌이 발생하여 메시지가 손실되거나 왜곡될 수 있기 때문에 충돌 방지 시스템이 필요
- ### 데이터 링크 계층
    이더넷 프레임을 통해 에러 확인, 흐름 제어, 접근 제어를 담당하는 계층
  - #### 이더넷 : 근거리 유선 네트워크인 LAN 을 구현하는 표준 기술로, 주로 컴퓨터와 같은 장치를 연결하여 데이터를 전송하는 데 사용
  - #### MAC 주소 : 컴퓨터나 노트북 등 각 장치에는 네트워크에 연결하기 위한 장치(LAN 카드)가 있는데, 이를 구별하기 위한 식별번호
  - #### 이더넷 프레임 : 이더넷 기반의 네트워크에서 데이터를 전송할 때 사용되는 기본 단위
    컴퓨터와 네트워크 장치 간에 정보를 교환하기 위해 사용되며, 이더넷 프레임은 표준화된 구조를 가지고 있어 서로 다른 장치들 간의 데이터 전송을 원활하게 함
  ![Image](https://velog.velcdn.com/images/leesfact/post/054009b5-5548-4da0-9829-08c8b5256204/image.png)
    - Preamble : 이더넷 프레임이 시작임을 알림
    - SFD(Start Frame Delimiter) : 다음 바이트부터 MAC 주소 필드가 시작됨을 알림
    - DMAC, SMAC : 수신(D), 송신(S) MAC 주소
    - EtherType : 데이터 계층 위의 계층인 IP 프로토콜을 정의
    - Payload : 전달받은 데이터
    - FCS(Frame Check Sequence) : 프레임의 오류를 검출하기 위한 필드

## 계층 간 데이터 송수신 과정
![Image](https://velog.velcdn.com/images/alkwen0996/post/54dafce3-2dba-475b-9ecf-7b9cceebb080/image.png)
애플리케이션 계층에서 전송 계층으로 보내는 요청(request) 값들이 `캡슐화` 과정을 거쳐 전달되고, 다시 링크 계층을 통해 해당 서버와 통신을 하고, 해당 서버의 링크 계층으로부터 애플리케이션까지 비캡슐화 과정을 거쳐 데이터가 전송됨
- ### 캡슐화 과정
    상위 계층의 헤더와 데이터를 하위 계층의 데이터 부분에 포함시키고 해당 계층의 헤더를 삽입하는 과정
    ![Image](https://velog.velcdn.com/images/alkwen0996/post/9e12e34a-a2d4-402a-9701-a63665e84db8/image.png)
    `세그먼트 또는 데이터그램화` : 데이터 + `TCP(L4) 헤더`  
    `패킷화` : 데이터 + TCP(L4) 헤더 + `IP(L3) 헤더`  
    `프레임화` : 데이터 + TCP(L4) 헤더 + IP(L3) 헤더 + `프레임 헤더 + 프레임 트레일러`
- ### 비캡슐화 과정
    하위 계층에서 상위 계층으로 가며 각 계층의 헤더 부분을 제거하는 과정
    ![Image](https://velog.velcdn.com/images/alkwen0996/post/fdbc5002-091e-445e-9f07-fe6d6b310bd7/image.png)
    최종적으로 사용자에게 애플리케이션의 PDU 인 메시지로 전달됨

## 2.2.2 PDU
네트워크의 어떠한 계층에서 계층으로 데이터가 전달되 때 한 덩어리의 단위(Protocol Data Unit)  
제어 관련 정보들이 포함된 `헤더`, 데이터를 의미하는 `페이로드`로 구성됨
- 애플리케이션 계층 : 메시지
- 전송 계층 : 세그먼트(TCP), 데이터그램(UDP)
- 인터넷 계층 : 패킷
- 링크 계층 : 프레임(데이터 링크 계층), 비트(물리 계층)
